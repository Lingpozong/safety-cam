<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WalkSafe AI Omni (Custom Fonts)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=DotGothic16&family=Oswald:wght@700&display=swap" rel="stylesheet">
    
    <style>
        /* === 1. Âä†ËΩΩÊú¨Âú∞Â≠ó‰Ωì === */
        /* ËØ∑Á°Æ‰øù impact.ttf Âíå pixel.ttf ‰∏éÊ≠§HTMLÂú®Âêå‰∏ÄÊñá‰ª∂Â§π */
        
        @font-face {
            font-family: 'LocalImpact';
            src: url('impact.ttf'); /* ËØªÂèñÈáçÂëΩÂêçÂêéÁöÑ Impact */
        }
        
        @font-face {
            font-family: 'LocalPixel';
            src: url('pixel.ttf');  /* ËØªÂèñÈáçÂëΩÂêçÂêéÁöÑ May7 (ÂÖ®Â∞èÁ¥†) */
        }

        :root {
            /* === ÈªòËÆ§: Cyber Style === */
            --bg-color: #000000;
            --primary-color: #00f3ff;
            --secondary-color: rgba(0, 243, 255, 0.1);
            --danger-color: #ff2a2a;
            --text-color: #ffffff;
            --panel-bg: rgba(20, 20, 20, 0.75);
            --border-style: solid;
            --border-width: 1px;
            --border-radius: 12px;
            --font-main: 'Rajdhani', sans-serif;
            --blur-amt: 15px;
            --scan-line-display: block;
            --stop-bg: rgba(50, 0, 0, 0.8);
            --stop-border: rgba(255, 42, 42, 0.6);
            --btn-active-shadow: 0 0 10px var(--primary-color);
        }

        /* === Modern Style (ÊûÅÁÆÄÁôΩ) === */
        [data-theme="modern"] {
            --bg-color: #f0f2f5;
            --primary-color: #007aff;
            --secondary-color: rgba(0, 122, 255, 0.1);
            --danger-color: #ff3b30;
            --text-color: #1d1d1f;
            --panel-bg: rgba(255, 255, 255, 0.85);
            --border-style: solid;
            --border-width: 0px;
            --border-radius: 20px;
            --font-main: 'Rajdhani', sans-serif;
            --blur-amt: 20px;
            --scan-line-display: none;
            --stop-bg: rgba(255, 59, 48, 0.9);
            --stop-border: transparent;
            --btn-active-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        /* === Safety Style (Â∑•Á®ãÈªÑ - ImpactÂ≠ó‰Ωì) === */
        [data-theme="safety"] {
            --bg-color: #000000;
            --primary-color: #fbff00;
            --secondary-color: #333;
            --danger-color: #ff0000;
            --text-color: #fbff00;
            --panel-bg: #1a1a1a;
            --border-style: solid;
            --border-width: 4px;
            --border-radius: 0px;
            /* ‰ºòÂÖà‰ΩøÁî®Êú¨Âú∞ LocalImpact */
            --font-main: 'LocalImpact', 'Impact', 'Oswald', sans-serif; 
            --blur-amt: 0px;
            --scan-line-display: none;
            --stop-bg: #ff0000;
            --stop-border: #ffffff;
            --btn-active-shadow: none;
        }

        /* === Pixel Style (ÂÖ®Â∞èÁ¥† May7 - ÈªëËâ≤Â≠ó‰Ωì) === */
        [data-theme="pixel"] {
            --bg-color: #5c94fc; 
            --primary-color: #000000; 
            --secondary-color: #e86a17; 
            --danger-color: #ff0000;
            --text-color: #000000; /* Á∫ØÈªëÂ≠ó‰Ωì */
            --panel-bg: #e86a17; 
            --border-style: dashed;
            --border-width: 4px;
            --border-radius: 0px;
            /* ‰ºòÂÖà‰ΩøÁî®Êú¨Âú∞ LocalPixel (ÂÖ®Â∞èÁ¥†) */
            --font-main: 'LocalPixel', 'DotGothic16', monospace; 
            --blur-amt: 0px;
            --scan-line-display: none;
            --stop-bg: #000000;
            --stop-border: #ffffff;
            --btn-active-shadow: 4px 4px 0px #000000;
        }

        body { 
            margin: 0; background: var(--bg-color); overflow: hidden; 
            font-family: var(--font-main);
            touch-action: manipulation;
            color: var(--text-color);
            transition: background 0.5s, color 0.5s;
        }
        
        #video, #pip-video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
            opacity: 0.5; z-index: 2; pointer-events: none;
            animation: scan 3s linear infinite; 
            display: var(--scan-line-display);
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 70px;
            z-index: 10; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; pointer-events: auto;
        }

        .status-group { display: flex; gap: 10px; }

        .status-badge {
            background: var(--secondary-color); 
            border: 1px solid var(--primary-color);
            padding: 5px 12px; border-radius: 4px; font-size: 14px; 
            color: var(--text-color); 
            border-color: var(--text-color);
            font-family: var(--font-main);
            opacity: 0.9;
        }

        #theme-btn {
            background: var(--secondary-color);
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 20px;
            font-family: var(--font-main);
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.2s;
            text-transform: uppercase;
            font-weight: bold;
        }
        #theme-btn:active { transform: scale(0.9); }

        #control-panel {
            position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: var(--panel-bg);
            backdrop-filter: blur(var(--blur-amt)); -webkit-backdrop-filter: blur(var(--blur-amt));
            border: var(--border-width) var(--border-style) rgba(255,255,255,0.2);
            border-radius: var(--border-radius); 
            padding: 15px 10px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 20; display: none;
            transition: all 0.3s;
        }

        .ctrl-btn {
            background: transparent; 
            border: 1px solid rgba(128,128,128,0.5);
            color: var(--text-color); 
            padding: 8px 0; width: 32%; 
            border-radius: 8px;
            font-family: var(--font-main); font-weight: 700; font-size: 14px;
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .ctrl-btn:active { transform: scale(0.95); }
        .ctrl-btn.active { 
            background: var(--secondary-color); 
            border-color: var(--text-color); 
            color: var(--text-color);
            box-shadow: var(--btn-active-shadow);
        }
        
        #stop-bar {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 50px;
            background: var(--stop-bg);
            backdrop-filter: blur(5px);
            border: 2px solid var(--stop-border);
            border-radius: var(--border-radius);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 20; display: none;
            transition: all 0.2s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        
        #stop-bar:active { transform: translateX(-50%) scale(0.98); opacity: 0.8; }
        
        .stop-text {
            color: white; font-size: 16px; font-weight: bold; letter-spacing: 2px;
            font-family: var(--font-main);
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .glow-circle {
            width: 120px; height: 120px; border-radius: 50%;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .start-text { font-size: 18px; font-weight: bold; color: var(--primary-color); font-family: 'Rajdhani'; }

        #danger-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(255, 0, 0, 0.8) 100%);
            z-index: 5; display: none; pointer-events: none;
            border: 4px solid red; box-sizing: border-box;
        }
    </style>
</head>
<body data-theme="cyber">

    <div id="start-screen">
        <div class="glow-circle" onclick="startSystem()">
            <span class="start-text">START</span>
        </div>
        <div style="margin-top:20px; color:#888; font-size:12px; letter-spacing:2px; font-family:'Rajdhani'">AI PROTECTION</div>
    </div>

    <div id="top-bar" style="display:none;">
        <div class="status-group">
            <div class="status-badge">‚óè LIVE</div>
            <div class="status-badge" id="fps-badge">AI READY</div>
        </div>
        <button id="theme-btn" onclick="cycleTheme()">üé® CYBER</button>
    </div>
    
    <div class="scan-line" id="scan-line"></div>
    <div id="danger-overlay"></div>

    <video id="video" playsinline muted autoplay loop></video>
    <canvas id="canvas"></canvas>
    <video id="pip-video" playsinline muted autoplay loop></video>

    <div id="control-panel">
        <button id="mode-btn" class="ctrl-btn" onclick="toggleAlertMode()">
            <span>üö® ALERT</span>
            <span id="mode-text" style="font-size:10px; opacity:0.7">SOUND+VIB</span>
        </button>
        <button id="eco-btn" class="ctrl-btn" onclick="toggleEcoMode()">
            <span>‚ö°Ô∏è ECO</span>
            <span style="font-size:10px; opacity:0.7">OFF</span>
        </button>
        <button id="pip-btn" class="ctrl-btn" onclick="togglePiP()">
            <span>üì∫ PiP</span>
            <span style="font-size:10px; opacity:0.7">OPEN</span>
        </button>
    </div>
    
    <div id="stop-bar" onclick="stopSystem()">
        <span class="stop-text">üõë STOP SYSTEM</span>
    </div>

<script>
    const video = document.getElementById('video');
    const pipVideo = document.getElementById('pip-video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const startScreen = document.getElementById('start-screen');
    const controlPanel = document.getElementById('control-panel');
    const stopBar = document.getElementById('stop-bar');
    const topBar = document.getElementById('top-bar');
    const scanLine = document.getElementById('scan-line');
    const dangerOverlay = document.getElementById('danger-overlay');
    const fpsBadge = document.getElementById('fps-badge');
    const ecoBtn = document.getElementById('eco-btn');
    const modeBtn = document.getElementById('mode-btn');
    const modeText = document.getElementById('mode-text');
    const themeBtn = document.getElementById('theme-btn');

    let model = null;
    let isSystemRunning = false; 
    let isEcoMode = false;
    let audioCtx = null;
    let isDetecting = false; 
    
    let lastPredictionTime = 0;
    const PREDICTION_INTERVAL = 150; 
    const CONFIDENCE_THRESHOLD = 0.6; 
    let lastDangerTime = 0;        
    const DANGER_HOLD_TIME = 800;  
    let lastBeepTime = 0;
    const BEEP_INTERVAL = 500;     
    let lastVibrateTime = 0;
    const VIBRATE_INTERVAL = 1000;

    let dangerFrameCount = 0;
    const DANGER_TRIGGER_FRAMES = 3;
    const ROI_X_MIN = 0.25;
    const ROI_X_MAX = 0.75;

    let alertMode = 2; 
    let pipTarget = video; 
    let frameCount = 0; 
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    let animationId = null; 

    // === ‰∏ªÈ¢òÂàáÊç¢ÈÄªËæë ===
    const themes = ['cyber', 'modern', 'safety', 'pixel'];
    const themeNames = ['üé® CYBER', '‚òÄÔ∏è MODERN', 'üöß SAFETY', 'üëæ PIXEL'];
    let currentThemeIndex = 0;

    function cycleTheme() {
        currentThemeIndex = (currentThemeIndex + 1) % themes.length;
        const newTheme = themes[currentThemeIndex];
        document.body.setAttribute('data-theme', newTheme);
        themeBtn.innerText = themeNames[currentThemeIndex];
    }

    async function startSystem() {
        startScreen.style.opacity = '0';
        setTimeout(() => startScreen.style.display = 'none', 500);
        isSystemRunning = true; 
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                audioCtx = new AudioContext();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                startSilentHeartbeat();
            }
            if (window.Notification && Notification.permission !== "granted") {
                await Notification.requestPermission();
            }
            await setupCamera();
            if (navigator.vibrate) navigator.vibrate(50);
            topBar.style.display = 'flex';
            controlPanel.style.display = 'flex'; 
            stopBar.style.display = 'flex';
            loadModel();
        } catch (err) {
            alert("System Error: " + err.message);
            stopSystem(); 
        }
    }

    function stopSystem() {
        isSystemRunning = false;
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        if (pipVideo.srcObject) {
            try { pipVideo.srcObject.getTracks().forEach(track => track.stop()); } catch(e){}
            pipVideo.srcObject = null;
        }
        if (animationId) cancelAnimationFrame(animationId);
        if (audioCtx) audioCtx.close().then(() => { audioCtx = null; });
        if (document.pictureInPictureElement) document.exitPictureInPicture().catch(()=>{});
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        dangerFrameCount = 0;
        topBar.style.display = 'none';
        controlPanel.style.display = 'none';
        stopBar.style.display = 'none';
        dangerOverlay.style.display = 'none';
        startScreen.style.display = 'flex';
        setTimeout(() => startScreen.style.opacity = '1', 50);
    }

    function startSilentHeartbeat() {
        if (!audioCtx) return;
        try {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.value = 0.0001;
        } catch(e){}
    }

    function tryPlayBeep() {
        if (!audioCtx || !isSystemRunning) return;
        const now = Date.now();
        if (now - lastBeepTime < BEEP_INTERVAL) return;
        lastBeepTime = now;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        const type = themes[currentThemeIndex] === 'pixel' ? 'square' : 'sine';
        
        try {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; 
            o.frequency.setValueAtTime(800, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.15);
            g.gain.setValueAtTime(0.5, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.15);
        } catch(e) {}
    }

    function tryVibrate() {
        if (!navigator.vibrate || !isSystemRunning) return;
        const now = Date.now();
        if (now - lastVibrateTime < VIBRATE_INTERVAL) return;
        lastVibrateTime = now;
        navigator.vibrate([200, 50, 200]); 
    }

    function sendNotification() {
        try {
            if (window.Notification && Notification.permission === "granted") {
                const now = Date.now();
                if (window.lastNotif && now - window.lastNotif < 3000) return; 
                window.lastNotif = now;
                new Notification("‚ö†Ô∏è Warning!", { body: "Obstacle Detected" });
            }
        } catch(e) {}
    }

    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }, audio: false
        });
        video.srcObject = stream;
        video.setAttribute('playsinline', ''); 
        video.setAttribute('autoplay', '');    
        video.setAttribute('muted', '');       
        return new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.play();
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                resolve(video);
            };
        });
    }

    async function loadModel() {
        if(!isSystemRunning) return;
        fpsBadge.innerText = "LOADING...";
        try {
            if (!model) model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            if(isSystemRunning) {
                fpsBadge.innerText = "READY";
                detectFrame();
            }
        } catch(e) {
            fpsBadge.innerText = "ERROR";
        }
    }

    function detectFrame() {
        if (!isSystemRunning) return;

        const now = performance.now();
        frameCount++;
        if (video.paused && video.srcObject) video.play().catch(()=>{});
        
        // Ëé∑ÂèñÂΩìÂâç‰∏ªÈ¢òÂèòÈáè
        const style = getComputedStyle(document.body);
        const primaryColor = style.getPropertyValue('--primary-color').trim();
        const dangerColor = style.getPropertyValue('--danger-color').trim();
        const fontMain = style.getPropertyValue('--font-main').trim();
        const textColor = style.getPropertyValue('--text-color').trim(); 
        const currentTheme = themes[currentThemeIndex];

        if (isEcoMode) {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            ctx.strokeStyle = primaryColor;
            ctx.lineWidth = currentTheme === 'pixel' ? 4 : 2;
            
            ctx.beginPath();
            if (currentTheme === 'pixel') {
                ctx.rect(centerX - 40, centerY - 40, 80, 80);
            } else {
                ctx.arc(centerX, centerY, 50, 0, Math.PI * 2);
            }
            ctx.stroke();

            ctx.fillStyle = textColor; 
            ctx.font = `20px ${fontMain}`;
            ctx.textAlign = 'center';
            ctx.fillText("ECO MODE", centerX, centerY + 100);
        } else {
            if (canvas.width > 0) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            if (currentTheme !== 'modern') {
                const leftLine = canvas.width * ROI_X_MIN;
                const rightLine = canvas.width * ROI_X_MAX;
                
                ctx.setLineDash(currentTheme === 'pixel' ? [10, 10] : [5, 15]);
                ctx.strokeStyle = primaryColor;
                ctx.lineWidth = currentTheme === 'pixel' ? 4 : 2;
                ctx.globalAlpha = 0.3;
                
                ctx.beginPath();
                ctx.moveTo(leftLine, 0); ctx.lineTo(leftLine, canvas.height);
                ctx.moveTo(rightLine, 0); ctx.lineTo(rightLine, canvas.height);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.globalAlpha = 1.0;
            }
        }

        if (!isDetecting && (now - lastPredictionTime > PREDICTION_INTERVAL) && model) {
            isDetecting = true;
            model.detect(video, 20, CONFIDENCE_THRESHOLD).then(predictions => {
                if(isSystemRunning) processPredictions(predictions, primaryColor, dangerColor, fontMain, textColor, currentTheme);
                lastPredictionTime = performance.now();
                isDetecting = false;
                scheduleNextFrame(); 
            }).catch(() => {
                isDetecting = false;
                scheduleNextFrame();
            });
        } else {
            renderStatus(dangerColor, fontMain); 
            scheduleNextFrame();
        }
    }

    function processPredictions(predictions, primary, danger, font, textCol, theme) {
        let currentFrameDangerous = false;
        
        predictions.forEach(prediction => {
            if (['person', 'car', 'truck', 'bus'].includes(prediction.class)) {
                const [x, y, width, height] = prediction.bbox;
                const centerX = x + width / 2;
                const centerXRatio = centerX / canvas.width;
                const inSafeZone = (centerXRatio > ROI_X_MIN && centerXRatio < ROI_X_MAX);
                const ratio = height / video.videoHeight;
                const isBigEnough = ratio > 0.45;
                const isDanger = isBigEnough && inSafeZone;

                if (!isEcoMode) {
                    let color = isDanger ? danger : primary;
                    if (theme === 'modern' && !isDanger) color = 'rgba(255,255,255,0.3)';

                    ctx.strokeStyle = color;
                    ctx.lineWidth = (theme === 'pixel' || theme === 'safety') ? 6 : 4;
                    
                    ctx.beginPath();
                    if (theme === 'modern') {
                        roundRect(ctx, x, y, width, height, 15);
                    } else if (theme === 'pixel') {
                        ctx.rect(x, y, width, height);
                        ctx.fillStyle = color;
                        ctx.fillRect(x-5, y-5, 10, 10);
                        ctx.fillRect(x+width-5, y+height-5, 10, 10);
                    } else {
                        const lineLen = width * 0.2;
                        ctx.moveTo(x, y + lineLen); ctx.lineTo(x, y); ctx.lineTo(x + lineLen, y);
                        ctx.moveTo(x + width - lineLen, y); ctx.lineTo(x + width, y); ctx.lineTo(x + width, y + lineLen);
                        ctx.moveTo(x + width, y + height - lineLen); ctx.lineTo(x + width, y + height); ctx.lineTo(x + width - lineLen, y + height);
                        ctx.moveTo(x + lineLen, y + height); ctx.lineTo(x, y + height); ctx.lineTo(x, y + height - lineLen);
                    }
                    ctx.stroke();

                    if (inSafeZone) {
                        ctx.fillStyle = color;
                        if (theme === 'modern') {
                             roundRect(ctx, x, y - 30, width, 25, 5, true);
                        } else {
                            ctx.fillRect(x, y - 30, width, 25);
                        }
                        
                        // Âº∫Âà∂È¢úËâ≤‰øÆÊ≠£
                        if (theme === 'pixel') {
                            ctx.fillStyle = 'black'; 
                        } else if (theme === 'safety') {
                            ctx.fillStyle = 'black';
                        } else if (theme === 'modern') {
                            ctx.fillStyle = 'white';
                        } else {
                            ctx.fillStyle = 'black'; 
                        }
                        
                        // Â≠ó‰ΩìÂ§ßÂ∞è‰øÆÊ≠£
                        ctx.font = `bold 14px ${font}`;
                        if (theme === 'pixel') ctx.font = `12px ${font}`; 
                        
                        ctx.textAlign = 'center';
                        ctx.fillText(prediction.class.toUpperCase(), x + width/2, y - 12);
                    }
                }
                if (isDanger) currentFrameDangerous = true;
            }
        });

        if (currentFrameDangerous) {
            dangerFrameCount++;
        } else {
            dangerFrameCount = 0;
        }

        if (dangerFrameCount >= DANGER_TRIGGER_FRAMES) {
            lastDangerTime = Date.now();
        }
    }

    function roundRect(ctx, x, y, w, h, r, fill = false) {
        if (w < 2 * r) r = w / 2;
        if (h < 2 * r) r = h / 2;
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.arcTo(x + w, y, x + w, y + h, r);
        ctx.arcTo(x + w, y + h, x, y + h, r);
        ctx.arcTo(x, y + h, x, y, r);
        ctx.arcTo(x, y, x + w, y, r);
        ctx.closePath();
        if (fill) ctx.fill(); 
    }

    function renderStatus(color, font) {
        const now = Date.now();
        const isEffectivelyDangerous = (now - lastDangerTime < DANGER_HOLD_TIME);

        if (isEffectivelyDangerous) {
            if (alertMode === 0 || alertMode === 2) tryPlayBeep();
            if (alertMode === 1 || alertMode === 2) tryVibrate();
            sendNotification();
            
            dangerOverlay.style.display = 'block';
            
            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2, canvas.height/2 - 50);
            ctx.lineTo(canvas.width/2 - 50, canvas.height/2 + 50);
            ctx.lineTo(canvas.width/2 + 50, canvas.height/2 + 50);
            ctx.closePath();
            ctx.stroke();
            
            ctx.font = `bold 60px ${font}`;
            ctx.textAlign = 'center';
            ctx.fillText("!", canvas.width/2, canvas.height/2 + 35);
            
            let warningText = "WARNING";
            if (alertMode === 1) warningText = "SILENT";
            ctx.font = `bold 40px ${font}`;
            ctx.fillText(warningText, canvas.width/2, canvas.height/2 + 100);
        } else {
            dangerOverlay.style.display = 'none';
        }
    }

    function scheduleNextFrame() {
        if (!isSystemRunning) return;
        if (document.hidden || document.pictureInPictureElement) {
            setTimeout(detectFrame, 50); 
        } else {
            animationId = requestAnimationFrame(detectFrame);
        }
    }

    function toggleEcoMode() {
        if(!isSystemRunning) return;
        if (isIOS) alert("Manual Dimming Required on iOS");
        isEcoMode = !isEcoMode;
        if (isEcoMode) {
            ecoBtn.classList.add('active');
            ecoBtn.querySelector('span:last-child').innerText = "ON";
        } else {
            ecoBtn.classList.remove('active');
            ecoBtn.querySelector('span:last-child').innerText = "OFF";
        }
    }
    
    function toggleAlertMode() {
        if(!isSystemRunning) return;
        alertMode = (alertMode + 1) % 3; 
        
        let label = "";
        let icon = "";
        switch(alertMode) {
            case 0: label = "SOUND"; icon = "üîä"; modeBtn.classList.remove('active'); break;
            case 1: label = "VIB"; icon = "üì≥"; modeBtn.classList.add('active'); 
                    if (isIOS) alert("Vibration blocked by iOS Safari"); break;
            case 2: label = "BOTH"; icon = "üö®"; modeBtn.classList.add('active'); break;
        }
        modeBtn.querySelector('span:first-child').innerText = icon + " ALERT";
        modeBtn.querySelector('span:last-child').innerText = label;
        if (alertMode > 0 && navigator.vibrate) navigator.vibrate(50);
    }

    async function togglePiP() {
        if(!isSystemRunning) return;
        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
            } else {
                if (pipTarget.readyState === 0) { alert("Buffering..."); return; }
                await pipTarget.requestPictureInPicture();
            }
        } catch (error) {
            if (video.webkitSetPresentationMode) {
                video.webkitSetPresentationMode(video.webkitPresentationMode === "inline" ? "picture-in-picture" : "inline");
            }
        }
    }
</script>
</body>
</html>
