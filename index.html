<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WalkSafe AI Ultimate (Precision)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00f3ff;
            --danger-color: #ff2a2a;
            --bg-glass: rgba(20, 20, 20, 0.75);
            --border-glass: rgba(255, 255, 255, 0.15);
        }

        body { 
            margin: 0; background: black; overflow: hidden; 
            font-family: 'Rajdhani', sans-serif;
            touch-action: manipulation;
            color: white;
        }
        
        #video, #pip-video { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }

        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 5px;
            background: linear-gradient(to right, transparent, var(--primary-color), transparent);
            opacity: 0.5; z-index: 2; pointer-events: none;
            animation: scan 3s linear infinite; display: none;
        }
        @keyframes scan { 0% { top: 0%; } 100% { top: 100%; } }

        #top-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            z-index: 10; display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-sizing: border-box; pointer-events: none;
        }
        .status-badge {
            background: rgba(0, 243, 255, 0.1); border: 1px solid var(--primary-color);
            padding: 5px 12px; border-radius: 4px; font-size: 14px; color: var(--primary-color);
            text-shadow: 0 0 5px var(--primary-color); letter-spacing: 1px;
        }

        /* === 1. ‰∏äÂ±ÇÂäüËÉΩÊéßÂà∂Âè∞ === */
        #control-panel {
            position: absolute; bottom: 90px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: var(--bg-glass);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--border-glass);
            border-radius: 20px; padding: 15px 10px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 20; display: none;
        }

        .ctrl-btn {
            background: transparent; border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 0; width: 32%; 
            border-radius: 12px;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 14px;
            cursor: pointer; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .ctrl-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .ctrl-btn.active { 
            background: rgba(0, 243, 255, 0.2); 
            border-color: var(--primary-color); 
            color: var(--primary-color);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }
        
        /* === 2. Â∫ïÈÉ®ÁªàÊ≠¢Ê®™Êù° === */
        #stop-bar {
            position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 50px;
            background: rgba(50, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 42, 42, 0.6);
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 20; display: none;
            transition: all 0.2s;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        
        #stop-bar:active {
            transform: translateX(-50%) scale(0.98);
            background: rgba(255, 42, 42, 0.4);
        }
        
        .stop-text {
            color: #ff4d4d; font-size: 16px; font-weight: bold; letter-spacing: 3px;
            text-shadow: 0 0 5px rgba(255, 42, 42, 0.5);
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .glow-circle {
            width: 120px; height: 120px; border-radius: 50%;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--primary-color), inset 0 0 20px var(--primary-color);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 20px var(--primary-color); transform: scale(1); }
            50% { box-shadow: 0 0 40px var(--primary-color); transform: scale(1.05); }
            100% { box-shadow: 0 0 20px var(--primary-color); transform: scale(1); }
        }
        .start-text { font-size: 18px; font-weight: bold; color: var(--primary-color); }
        .sub-text { margin-top: 20px; color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 2px;}

        #danger-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 40%, rgba(255, 0, 0, 0.8) 100%);
            z-index: 5; display: none; pointer-events: none;
            border: 4px solid red; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="glow-circle" onclick="startSystem()">
            <span class="start-text">INITIALIZE</span>
        </div>
        <div class="sub-text">WalkSafe AI Protection</div>
    </div>

    <div id="top-bar" style="display:none;">
        <div class="status-badge">‚óè LIVE</div>
        <div class="status-badge" id="fps-badge">AI: READY</div>
    </div>
    
    <div class="scan-line" id="scan-line"></div>
    <div id="danger-overlay"></div>

    <video id="video" playsinline muted autoplay loop></video>
    <canvas id="canvas"></canvas>
    <video id="pip-video" playsinline muted autoplay loop></video>

    <div id="control-panel">
        <button id="mode-btn" class="ctrl-btn" onclick="toggleAlertMode()">
            <span>üö® ALERT</span>
            <span id="mode-text" style="font-size:10px; opacity:0.7">SOUND+VIB</span>
        </button>
        <button id="eco-btn" class="ctrl-btn" onclick="toggleEcoMode()">
            <span>‚ö°Ô∏è ECO</span>
            <span style="font-size:10px; opacity:0.7">OFF</span>
        </button>
        <button id="pip-btn" class="ctrl-btn" onclick="togglePiP()">
            <span>üì∫ PiP</span>
            <span style="font-size:10px; opacity:0.7">OPEN</span>
        </button>
    </div>
    
    <div id="stop-bar" onclick="stopSystem()">
        <span class="stop-text">üõë SYSTEM TERMINATE</span>
    </div>

<script>
    const video = document.getElementById('video');
    const pipVideo = document.getElementById('pip-video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements
    const startScreen = document.getElementById('start-screen');
    const controlPanel = document.getElementById('control-panel');
    const stopBar = document.getElementById('stop-bar');
    const topBar = document.getElementById('top-bar');
    const scanLine = document.getElementById('scan-line');
    const dangerOverlay = document.getElementById('danger-overlay');
    const fpsBadge = document.getElementById('fps-badge');
    const ecoBtn = document.getElementById('eco-btn');
    const modeBtn = document.getElementById('mode-btn');
    const modeText = document.getElementById('mode-text');

    let model = null;
    let isSystemRunning = false; 
    let isEcoMode = false;
    let audioCtx = null;
    let isDetecting = false; 
    
    let lastPredictionTime = 0;
    const PREDICTION_INTERVAL = 150; // Á®çÂæÆÂä†Âø´Ê£ÄÊµãÈ¢ëÁéá‰ª•ÈÖçÂêàÈò≤Êäñ
    const CONFIDENCE_THRESHOLD = 0.6; 
    
    let lastDangerTime = 0;        
    const DANGER_HOLD_TIME = 800;  
    
    let lastBeepTime = 0;
    const BEEP_INTERVAL = 500;     
    
    let lastVibrateTime = 0;
    const VIBRATE_INTERVAL = 1000;

    // === Êñ∞Â¢ûÔºöÈò≤ÊäñÂä®‰∏éËÅöÁÑ¶ÈÄªËæëÂèÇÊï∞ ===
    let dangerFrameCount = 0;          // ËøûÁª≠Âç±Èô©Â∏ßËÆ°Êï∞Âô®
    const DANGER_TRIGGER_FRAMES = 3;   // ÈúÄË¶ÅËøûÁª≠3Â∏ßÊâçËß¶Âèë (ÊñπÊ°à B)
    const ROI_X_MIN = 0.25;            // Â±èÂπïÂ∑¶‰æß 25%
    const ROI_X_MAX = 0.75;            // Â±èÂπïÂè≥‰æß 75% (Âç≥Âè™Ê£ÄÊµã‰∏≠Èó¥50%) (ÊñπÊ°à A)

    let alertMode = 2; // Default: Both
    
    let pipTarget = video; 
    let frameCount = 0; 
    const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
    let animationId = null; 

    async function startSystem() {
        startScreen.style.opacity = '0';
        setTimeout(() => startScreen.style.display = 'none', 500);
        
        isSystemRunning = true; 

        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (AudioContext) {
                audioCtx = new AudioContext();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                startSilentHeartbeat();
            }

            if (window.Notification && Notification.permission !== "granted") {
                await Notification.requestPermission();
            }
            
            await setupCamera();
            if (navigator.vibrate) navigator.vibrate(50);

            topBar.style.display = 'flex';
            controlPanel.style.display = 'flex'; 
            stopBar.style.display = 'flex';
            scanLine.style.display = 'block';

            if (isIOS) {
                pipTarget = video; 
            } else {
                try {
                    const stream = canvas.captureStream(30);
                    if (stream.getVideoTracks().length > 0) {
                        pipVideo.srcObject = stream;
                        await new Promise(r => setTimeout(r, 100)); 
                        pipTarget = pipVideo; 
                    } else {
                        pipTarget = video;
                    }
                } catch (e) {
                    pipTarget = video;
                }
            }
            
            loadModel();

        } catch (err) {
            alert("System Error: " + err.message);
            stopSystem(); 
        }
    }

    function stopSystem() {
        isSystemRunning = false;
        
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
        if (pipVideo.srcObject) {
            try { pipVideo.srcObject.getTracks().forEach(track => track.stop()); } catch(e){}
            pipVideo.srcObject = null;
        }

        if (animationId) cancelAnimationFrame(animationId);
        if (audioCtx) audioCtx.close().then(() => { audioCtx = null; });
        if (document.pictureInPictureElement) document.exitPictureInPicture().catch(()=>{});

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ÈáçÁΩÆÈò≤ÊäñËÆ°Êï∞Âô®
        dangerFrameCount = 0;

        topBar.style.display = 'none';
        controlPanel.style.display = 'none';
        stopBar.style.display = 'none';
        scanLine.style.display = 'none';
        dangerOverlay.style.display = 'none';
        
        startScreen.style.display = 'flex';
        setTimeout(() => startScreen.style.opacity = '1', 50);
    }

    function startSilentHeartbeat() {
        if (!audioCtx) return;
        try {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); g.gain.value = 0.0001;
        } catch(e){}
    }

    function tryPlayBeep() {
        if (!audioCtx || !isSystemRunning) return;
        const now = Date.now();
        if (now - lastBeepTime < BEEP_INTERVAL) return;
        lastBeepTime = now;
        if (audioCtx.state === 'suspended') audioCtx.resume();

        try {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = 'square'; 
            o.frequency.setValueAtTime(800, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.15);
            g.gain.setValueAtTime(0.5, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + 0.15);
        } catch(e) {}
    }

    function tryVibrate() {
        if (!navigator.vibrate || !isSystemRunning) return;
        const now = Date.now();
        if (now - lastVibrateTime < VIBRATE_INTERVAL) return;
        lastVibrateTime = now;
        navigator.vibrate([200, 50, 200]); 
    }

    function sendNotification() {
        try {
            if (window.Notification && Notification.permission === "granted") {
                const now = Date.now();
                if (window.lastNotif && now - window.lastNotif < 3000) return; 
                window.lastNotif = now;
                new Notification("‚ö†Ô∏è Ë°ùÁ™ÅË≠¶ÂëäÔºÅ", { body: "LOOK OUT!" });
            }
        } catch(e) {}
    }

    async function setupCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: 'environment' }, audio: false
        });
        video.srcObject = stream;
        video.setAttribute('playsinline', ''); 
        video.setAttribute('autoplay', '');    
        video.setAttribute('muted', '');       
        return new Promise((resolve) => {
            video.onloadedmetadata = () => {
                video.play();
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                resolve(video);
            };
        });
    }

    async function loadModel() {
        if(!isSystemRunning) return;
        fpsBadge.innerText = "LOADING AI...";
        try {
            if (!model) model = await cocoSsd.load({ base: 'lite_mobilenet_v2' });
            if(isSystemRunning) {
                fpsBadge.innerText = "SYSTEM ACTIVE";
                fpsBadge.style.color = "#00f3ff";
                detectFrame();
            }
        } catch(e) {
            fpsBadge.innerText = "AI ERROR";
            fpsBadge.style.color = "red";
        }
    }

    function detectFrame() {
        if (!isSystemRunning) return;

        const now = performance.now();
        frameCount++;
        if (video.paused && video.srcObject) video.play().catch(()=>{});
        
        if (isEcoMode) {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            // Eco mode drawing...
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.3)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(centerX, centerY, 50, 0, Math.PI * 2);
            ctx.stroke();
            ctx.fillStyle = `rgba(0, 243, 255, 0.5)`;
            ctx.font = '20px "Rajdhani"';
            ctx.textAlign = 'center';
            ctx.fillText("ECO SURVEILLANCE ACTIVE", centerX, centerY + 100);
        } else {
            if (canvas.width > 0) ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // === ÁªòÂà∂ ÊñπÊ°àA ÁöÑËßÜËßâËæÖÂä©Á∫ø (‰∏≠Èó¥ÁöÑÂÆâÂÖ®ÈÄöÈÅì) ===
            const leftLine = canvas.width * ROI_X_MIN;
            const rightLine = canvas.width * ROI_X_MAX;
            
            ctx.setLineDash([5, 15]); // ËôöÁ∫ø
            ctx.strokeStyle = 'rgba(0, 243, 255, 0.3)'; // Ê∑°Ê∑°ÁöÑÈùíËâ≤
            ctx.lineWidth = 2;
            
            ctx.beginPath();
            ctx.moveTo(leftLine, 0); ctx.lineTo(leftLine, canvas.height);
            ctx.moveTo(rightLine, 0); ctx.lineTo(rightLine, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]); // ÊÅ¢Â§çÂÆûÁ∫ø
        }

        if (!isDetecting && (now - lastPredictionTime > PREDICTION_INTERVAL) && model) {
            isDetecting = true;
            model.detect(video, 20, CONFIDENCE_THRESHOLD).then(predictions => {
                if(isSystemRunning) processPredictions(predictions);
                lastPredictionTime = performance.now();
                isDetecting = false;
                scheduleNextFrame(); 
            }).catch(() => {
                isDetecting = false;
                scheduleNextFrame();
            });
        } else {
            renderStatus(); 
            scheduleNextFrame();
        }
    }

    function processPredictions(predictions) {
        let currentFrameDangerous = false;
        
        predictions.forEach(prediction => {
            if (['person', 'car', 'truck', 'bus'].includes(prediction.class)) {
                const [x, y, width, height] = prediction.bbox;
                
                // === ÊñπÊ°àA: ËÆ°ÁÆóÁâ©‰Ωì‰∏≠ÂøÉÁÇπÔºåÂà§Êñ≠ÊòØÂê¶Âú®Ê†∏ÂøÉÂå∫Âüü ===
                const centerX = x + width / 2;
                const centerXRatio = centerX / canvas.width;
                const inSafeZone = (centerXRatio > ROI_X_MIN && centerXRatio < ROI_X_MAX);
                
                // === Â§ßÂ∞èÂà§ÂÆö ===
                const ratio = height / video.videoHeight;
                const isBigEnough = ratio > 0.45;
                
                // Âè™Êúâ ‚ÄúÊó¢Ë∂≥Â§üÂ§ß‚Äù Âèà ‚ÄúÂú®‰∏≠Èó¥Âå∫Âüü‚Äù ÊâçÁÆóÂç±Èô©
                const isDanger = isBigEnough && inSafeZone;

                if (!isEcoMode) {
                    // Âè™ÊúâÂç±Èô©Áâ©‰ΩìÊ†áÁ∫¢ÔºåÊóÅËæπË∑ØËøáÁöÑÊ†áËìù
                    const color = isDanger ? '#ff2a2a' : 'rgba(0, 243, 255, 0.4)'; 
                    
                    // Â¶ÇÊûú‰∏çÂú®‰∏≠Èó¥Âå∫ÂüüÔºåÈôç‰Ωé‰∏çÈÄèÊòéÂ∫¶ÔºåË°®Á§∫Ë¢´Á≥ªÁªüÂøΩÁï•
                    ctx.globalAlpha = inSafeZone ? 1.0 : 0.5;
                    
                    const lineLen = width * 0.2;
                    ctx.strokeStyle = color;
                    ctx.lineWidth = inSafeZone ? 4 : 2;
                    ctx.beginPath();
                    ctx.moveTo(x, y + lineLen); ctx.lineTo(x, y); ctx.lineTo(x + lineLen, y);
                    ctx.moveTo(x + width - lineLen, y); ctx.lineTo(x + width, y); ctx.lineTo(x + width, y + lineLen);
                    ctx.moveTo(x + width, y + height - lineLen); ctx.lineTo(x + width, y + height); ctx.lineTo(x + width - lineLen, y + height);
                    ctx.moveTo(x + lineLen, y + height); ctx.lineTo(x, y + height); ctx.lineTo(x, y + height - lineLen);
                    ctx.stroke();
                    
                    ctx.globalAlpha = 1.0;

                    if (inSafeZone) {
                        ctx.fillStyle = color;
                        ctx.fillRect(x, y - 25, width, 25);
                        ctx.fillStyle = 'black';
                        ctx.font = 'bold 16px "Rajdhani"';
                        ctx.textAlign = 'left';
                        ctx.fillText(prediction.class.toUpperCase() + " " + Math.round(prediction.score*100) + "%", x + 5, y - 7);
                    }
                }
                
                if (isDanger) currentFrameDangerous = true;
            }
        });

        // === ÊñπÊ°àB: Èò≤ÊäñÈÄªËæë (Debounce) ===
        if (currentFrameDangerous) {
            dangerFrameCount++; // Âç±Èô©Â∏ß +1
        } else {
            dangerFrameCount = 0; // ‰∏ÄÊó¶‰∏≠Êñ≠ÔºåÁ´ãÂç≥ÈáçÁΩÆ (‰∏∫‰∫ÜËß£ÂÜ≥ËØØÊä•ÔºåÊàë‰ª¨ÈááÁî®‰∏•Ê†ºÈáçÁΩÆ)
        }

        // Âè™ÊúâËøûÁª≠ÁßØÁ¥Ø‰∫Ü3Â∏ßÂç±Èô©ÔºåÊâçÁúüÊ≠£Ëß¶ÂèëÂÖ®Â±ÄË≠¶Êä•Êó∂Èó¥
        if (dangerFrameCount >= DANGER_TRIGGER_FRAMES) {
            lastDangerTime = Date.now();
        }
    }

    function renderStatus() {
        const now = Date.now();
        const isEffectivelyDangerous = (now - lastDangerTime < DANGER_HOLD_TIME);

        if (isEffectivelyDangerous) {
            if (alertMode === 0 || alertMode === 2) tryPlayBeep();
            if (alertMode === 1 || alertMode === 2) tryVibrate();
            sendNotification();
            
            dangerOverlay.style.display = 'block';
            
            // ÁªòÂà∂Ë≠¶ÂëäÂõæÊ†á
            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(canvas.width/2, canvas.height/2 - 50);
            ctx.lineTo(canvas.width/2 - 50, canvas.height/2 + 50);
            ctx.lineTo(canvas.width/2 + 50, canvas.height/2 + 50);
            ctx.closePath();
            ctx.stroke();
            ctx.font = 'bold 60px "Rajdhani"';
            ctx.textAlign = 'center';
            ctx.fillText("!", canvas.width/2, canvas.height/2 + 35);
            
            let warningText = "WARNING";
            if (alertMode === 1) warningText = "SILENT WARN";
            ctx.font = 'bold 40px "Rajdhani"';
            ctx.fillText(warningText, canvas.width/2, canvas.height/2 + 100);
        } else {
            dangerOverlay.style.display = 'none';
        }
    }

    function scheduleNextFrame() {
        if (!isSystemRunning) return;
        if (document.hidden || document.pictureInPictureElement) {
            setTimeout(detectFrame, 50); 
        } else {
            animationId = requestAnimationFrame(detectFrame);
        }
    }

    function toggleEcoMode() {
        if(!isSystemRunning) return;
        if (isIOS) alert("Note: iOS screen dimming manual required.");
        isEcoMode = !isEcoMode;
        if (isEcoMode) {
            ecoBtn.classList.add('active');
            ecoBtn.querySelector('span:last-child').innerText = "ON";
        } else {
            ecoBtn.classList.remove('active');
            ecoBtn.querySelector('span:last-child').innerText = "OFF";
        }
    }
    
    function toggleAlertMode() {
        if(!isSystemRunning) return;
        alertMode = (alertMode + 1) % 3; 
        
        let label = "";
        let icon = "";
        switch(alertMode) {
            case 0: label = "SOUND ONLY"; icon = "üîä SOUND"; modeBtn.classList.remove('active'); break;
            case 1: label = "VIB ONLY"; icon = "üì≥ VIBRATE"; modeBtn.classList.add('active'); 
                    if (isIOS) alert("iPhoneÊ≥®ÊÑèÔºö\nWeb„Çµ„Ç§„Éà„Åã„Çâ„ÅÆÊåØÂãï„ÅØiOS„Åß„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ"); break;
            case 2: label = "SOUND+VIB"; icon = "üö® BOTH"; modeBtn.classList.add('active'); break;
        }
        modeBtn.querySelector('span:first-child').innerText = icon;
        modeText.innerText = label;
        if (alertMode > 0 && navigator.vibrate) navigator.vibrate(50);
    }

    async function togglePiP() {
        if(!isSystemRunning) return;
        try {
            if (document.pictureInPictureElement) {
                await document.exitPictureInPicture();
            } else {
                if (pipTarget.readyState === 0) { alert("Buffering..."); return; }
                await pipTarget.requestPictureInPicture();
            }
        } catch (error) {
            if (video.webkitSetPresentationMode) {
                video.webkitSetPresentationMode(video.webkitPresentationMode === "inline" ? "picture-in-picture" : "inline");
            }
        }
    }
</script>
</body>
</html>
